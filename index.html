<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue Audio Recorder and OpenAI Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <h1>Audio Recorder and Speech-to-Text</h1>

        <div v-if="transcription">
            <h2>Transcription:</h2>
            <p>{{ transcription }}</p>
        </div>

        <audio v-if="audioUrl" :src="audioUrl" controls autoplay></audio>

        <!-- Create Thread Section -->
        <h2>Create Thread</h2>
        <button @click="createThread">Create Thread</button>
        <div v-if="threadResponse">
            <h3>Thread Response:</h3>
            <pre>{{ threadResponse }}</pre>
        </div>
        <div v-if="threadId">
            <h3>Thread ID:</h3>
            <p>{{ threadId }}</p>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                recording: false,
                mediaRecorder: null,
                audioChunks: [],
                transcription: '',
                audioUrl: null,
                apiKey: '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', // Replace with your actual API key
                threadResponse: null,
                threadId: null,
                threadRunResponse: null,
                error: null
            },
            mounted() {
                window.addEventListener('keydown', this.handleKeyDown);
                window.addEventListener('keyup', this.handleKeyUp);
            },
            beforeDestroy() {
                window.removeEventListener('keydown', this.handleKeyDown);
                window.removeEventListener('keyup', this.handleKeyUp);
            },
            methods: {
                handleKeyDown(event) {
                    if (event.key === 't' && !this.recording) {
                        this.startRecording();
                    }
                },
                handleKeyUp(event) {
                    if (event.key === 't' && this.recording) {
                        this.stopRecording();
                    }
                },
                async startRecording() {
                    this.recording = true;
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.mediaRecorder.start();

                    this.mediaRecorder.ondataavailable = event => {
                        this.audioChunks.push(event.data);
                    };

                    this.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                        this.audioChunks = [];

                        const formData = new FormData();
                        formData.append('file', audioBlob, 'audio.wav');
                        formData.append('model', 'whisper-1');

                        axios.post('https://api.openai.com/v1/audio/transcriptions', formData, {
                            headers: {
                                'Authorization': `Bearer ${this.apiKey}`,
                                'Content-Type': 'multipart/form-data'
                            }
                        })
                            .then(response => {
                                this.transcription = response.data.text;
                                this.handleAndConvertToSpeech();
                            })
                            .catch(error => {
                                console.error('Error converting audio:', error);
                            });
                    };
                },
                stopRecording() {
                    this.recording = false;
                    this.mediaRecorder.stop();
                },
                textToSpeech(text) {
                    const url = 'https://api.openai.com/v1/audio/speech';
                    const data = {
                        model: "tts-1",
                        input: text,
                        voice: "alloy"
                    };

                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            const url = URL.createObjectURL(blob);
                            return url;
                        })
                        .catch(error => {
                            console.error('There was a problem with the fetch operation:', error);
                            throw error;
                        });
                },
                createThread() {
                    const url = 'http://localhost:3000/api/v1/eddie/threads/create-thread';

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to create thread');
                            }
                            return response.json();
                        })
                        .then(data => {
                            this.threadResponse = JSON.stringify(data, null, 2);
                            this.threadId = data.id;
                        })
                        .catch(error => {
                            console.error('Error creating thread:', error);
                            alert('Failed to create thread');
                        });
                },
                handleThreadRun() {
                    const url = 'http://localhost:3000/api/v1/eddie/threads/handle-thread-run';
                    const data = {
                        message: this.transcription,
                        threadId: this.threadId
                    };

                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to handle thread run');
                            }
                            return response.json();
                        })
                        .then(data => {
                            this.threadRunResponse = JSON.stringify(data, null, 2);
                            return data[0].text.value;
                        })
                        .catch(error => {
                            console.error('Error handling thread run:', error);
                            alert('Failed to handle thread run');
                            throw error;
                        });
                },
                handleAndConvertToSpeech() {
                    this.handleThreadRun()
                        .then(text => {
                            return this.textToSpeech(text);
                        })
                        .then(url => {
                            this.audioUrl = url;
                        })
                        .catch(error => {
                            console.error('Error in handleAndConvertToSpeech:', error);
                            alert('Failed to handle thread run and convert to speech');
                        });
                }
            }
        });
    </script>
</body>

</html>